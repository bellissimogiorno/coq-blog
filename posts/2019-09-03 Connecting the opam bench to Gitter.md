The [Coq opam bench system](https://coq-bench.github.io/) detects bugs in [opam](https://opam.ocaml.org/) packages from the [Coq repository](https://github.com/coq/opam-coq-archive). However these bugs may be hard to follow. Indeed, they are in a table one needs to consult regularly. We present a system to post results in a [Gitter](https://gitter.im/) channel [coq/opam-bench-reports](https://gitter.im/coq/opam-bench-reports). Thanks to this channel, we can more easily track down the latest build failures.

The idea of publishing results in Gitter was given by [Emilio Jesús Gallego Arias](https://www.cri.ensmp.fr/people/gallego/) in [coq/issues/10418](https://github.com/coq/coq/issues/10418). Improvements were added from suggestions from Emilio Jesús Gallego Arias and [Karl Palmskog](https://setoid.com/).

![Bench report in Gitter](static/images/opam-bench-gitter/report.png "Bench report in Gitter")

## Implementation
The code to publish results in Gitter is at [github.com/coq-bench/make-html](https://github.com/coq-bench/make-html). The implementation is in [Ruby](https://www.ruby-lang.org/) and shares code with the bench website generator. The results are extracted from a CSV database generated by the project [github.com/coq-bench/run](https://github.com/coq-bench/run) which tests the packages.

To connect to Gitter, we use the [ruby-gitter](https://github.com/kristenmills/ruby-gitter) package. The code goes as follows:

    # Use the developer token from the Gitter documentation
    # (what is possible as very few messages are sent)
    client = Gitter::Client.new(token)

    # Find the room id
    room = client.rooms.find {|room| room.name == "coq/opam-bench-reports"}
    room_id = room.id

    # Construct the message with the results
    message = "..."

    # Actually send the message
    client.send_message(message, room_id)

We use a dedicated [coq-opam-bench-gitter-bot](https://github.com/coq-opam-bench-gitter-bot) user to publish on Gitter and sign the messages. We retrieve the results of the past 72 hours, and run the code every 72 hours with a shell command:

    while true; do sleep 72h; date; git pull; ruby push_to_gitter.rb ../database gitter-token coq/opam-bench-reports 72; done

Note the `git pull` of hot code swapping! This is useful to integrate small bench updates without breaking the 72 hours rythm.

We either display the list of packages which failed, or a success message.

## Results
We went from dozens of errors every 72 hours (when setting up the system) to just a few these days. Probably, this was mainly due to the bug corrections themselves but it helped. The Gitter reports also created a channel to talk about opam bugs.
